---
- name: Advanced User Management
  hosts: local
  become: yes
  vars:
    users_to_create:
      - name: frank
        comment: "Frank Miller - DevOps Engineer"
        uid: 2006
        primary_group: developers
        secondary_groups: ["sysadmins", "project-alpha"]
        shell: /bin/bash
        home_dir: /home/frank
      - name: grace
        comment: "Grace Lee - Security Analyst"
        uid: 2007
        primary_group: testers
        secondary_groups: ["sysadmins"]
        shell: /bin/bash
        home_dir: /home/grace

  tasks:
    - name: Create users from list
      user:
        name: "{{ item.name }}"
        comment: "{{ item.comment }}"
        uid: "{{ item.uid }}"
        group: "{{ item.primary_group }}"
        groups: "{{ item.secondary_groups | join(',') }}"
        shell: "{{ item.shell }}"
        home: "{{ item.home_dir }}"
        create_home: yes
        state: present
      loop: "{{ users_to_create }}"

    - name: Lock temporarily unused account carol
      user:
        name: carol
        password_lock: yes

    - name: Generate user report
      shell: |
        echo "=== USER MANAGEMENT REPORT ===" > /tmp/user_report.txt
        date >> /tmp/user_report.txt
        echo "Created Users:" >> /tmp/user_report.txt
        getent passwd | grep -E "(alice|bob|carol|david|eve|frank|grace)" >> /tmp/user_report.txt
        echo "Created Groups:" >> /tmp/user_report.txt
        getent group | grep -E "(developers|testers|managers|contractors|project-alpha|sysadmins)" >> /tmp/user_report.txt
    - name: Show report
      shell: cat /tmp/user_report.txt
      register: user_report
    - name: Display report
      debug:
        msg: "{{ user_report.stdout_lines }}"
