---
- name: Firewall Rollback on Localhost
  hosts: localhost
  become: yes
  vars_files:
    - ../host_vars/localhost.yml
  vars:
    rollback_timestamp: "{{ ansible_date_time.epoch }}"
    backup_location: "/tmp/firewall-backups"

  tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_location }}"
        state: directory
        mode: '0755'

    - name: Backup current configuration
      shell: |
        firewall-cmd --list-all-zones > {{ backup_location }}/zones-{{ rollback_timestamp }}.backup
        firewall-cmd --get-default-zone > {{ backup_location }}/default-zone-{{ rollback_timestamp }}.backup
      notify: log backup creation

    - name: Reset firewall to default state
      command: firewall-cmd --complete-reload
      notify:
        - verify reset
        - log rollback action

    - name: Remove custom zones if any
      firewalld:
        zone: "{{ item }}"
        state: absent
        permanent: yes
      loop:
        - custom-web
        - custom-db
        - custom-app
      ignore_errors: yes
      notify: reload firewalld

    - name: Restore basic services only
      firewalld:
        zone: public
        service: "{{ item }}"
        state: enabled
        permanent: yes
        immediate: yes
      loop:
        - ssh
        - http
        - https
      notify:
        - reload firewalld

  handlers:
    - name: log backup creation
      lineinfile:
        path: "{{ backup_location }}/firewall-rollback.log"
        line: "{{ ansible_date_time.iso8601 }} - Backup created on {{ inventory_hostname }}"
        create: yes

    - name: log rollback action
      lineinfile:
        path: "{{ backup_location }}/firewall-rollback.log"
        line: "{{ ansible_date_time.iso8601 }} - Rollback completed on {{ inventory_hostname }}"
        create: yes

    - name: reload firewalld
      systemd:
        name: firewalld
        state: reloaded

    - name: verify reset
      command: firewall-cmd --list-all
      register: reset_check
      changed_when: false

    - name: display rollback results
      debug:
        msg: "Rollback completed. Active services: {{ reset_check.stdout }}"
